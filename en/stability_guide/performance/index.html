<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.40.1" />
    <meta name="description" content="Akira&#39;s guide for MongoDB">
<meta name="author" content="Akira Kurogane">

    <link rel="icon" href="/mongodb-guide/images/favicon.png" type="image/png">

    <title>Performance stability :: Akira&#39;s MongoDB Guide</title>

    
    <link href="/mongodb-guide/css/nucleus.css?1571450476" rel="stylesheet">
    <link href="/mongodb-guide/css/fontawesome-all.min.css?1571450476" rel="stylesheet">
    <link href="/mongodb-guide/css/hybrid.css?1571450476" rel="stylesheet">
    <link href="/mongodb-guide/css/featherlight.min.css?1571450476" rel="stylesheet">
    <link href="/mongodb-guide/css/perfect-scrollbar.min.css?1571450476" rel="stylesheet">
    <link href="/mongodb-guide/css/auto-complete.css?1571450476" rel="stylesheet">
    <link href="/mongodb-guide/css/atom-one-dark-reasonable.css?1571450476" rel="stylesheet">
    <link href="/mongodb-guide/css/theme.css?1571450476" rel="stylesheet">
    <link href="/mongodb-guide/css/hugo-theme.css?1571450476" rel="stylesheet">
    
      <link href="/mongodb-guide/css/theme-green.css?1571450476" rel="stylesheet">
    

    <script src="/mongodb-guide/js/jquery-3.3.1.min.js?1571450476"></script>

    <style type="text/css">
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
    
  </head>
  <body class="" data-url="/mongodb-guide/en/stability_guide/performance/">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="https://akira-kurogane.github.io/mongodb-guide/">

Akira's MongoDB Guide

</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/mongodb-guide/js/lunr.min.js?1571450476"></script>
<script type="text/javascript" src="/mongodb-guide/js/auto-complete.js?1571450476"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/akira-kurogane.github.io\/mongodb-guide\/\/en";
    
</script>
<script type="text/javascript" src="/mongodb-guide/js/search.js?1571450476"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/mongodb-guide/en/guide_intro/" title="What you can do with MongoDB" class="dd-item 
        
        
        
        ">
      <a href="/mongodb-guide/en/guide_intro/">
          <b>1. </b>What you can do with MongoDB
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/mongodb-guide/en/connecting_guide/" title="Connecting to MongoDB" class="dd-item 
        
        
        
        ">
      <a href="/mongodb-guide/en/connecting_guide/">
          <b>2. </b>Connecting to MongoDB
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/mongodb-guide/en/connecting_guide/human_ix/" title="How to connect from your app or a terminal" class="dd-item 
        
        
        
        ">
      <a href="/mongodb-guide/en/connecting_guide/human_ix/">
          Human how-to
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/mongodb-guide/en/connecting_guide/human_ix/conn_string_uri/" title="Connection string URI" class="dd-item 
        
        
        
        ">
      <a href="/mongodb-guide/en/connecting_guide/human_ix/conn_string_uri/">
          Connection string URI
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/mongodb-guide/en/connecting_guide/human_ix/mongo_shell/" title="The mongo shell" class="dd-item 
        
        
        
        ">
      <a href="/mongodb-guide/en/connecting_guide/human_ix/mongo_shell/">
          The mongo shell
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/mongodb-guide/en/connecting_guide/cs_nw_details/" title="Client-Server network communication" class="dd-item 
        
        
        
        ">
      <a href="/mongodb-guide/en/connecting_guide/cs_nw_details/">
          client ⇄ TCP ⇄ db server
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/mongodb-guide/en/connecting_guide/cs_nw_details/drivers/" title="Drivers and &#39;the wire&#39;" class="dd-item 
        
        
        
        ">
      <a href="/mongodb-guide/en/connecting_guide/cs_nw_details/drivers/">
          Drivers and &#39;the wire&#39;
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/mongodb-guide/en/connecting_guide/cs_nw_details/ha_connections/" title="Automatic failover" class="dd-item 
        
        
        
        ">
      <a href="/mongodb-guide/en/connecting_guide/cs_nw_details/ha_connections/">
          Automatic failover
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/mongodb-guide/en/rw_data_guide/" title="Reading and writing" class="dd-item 
        
        
        
        ">
      <a href="/mongodb-guide/en/rw_data_guide/">
          <b>3. </b>Reading and writing
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/mongodb-guide/en/rw_data_guide/mql_vs_sql/" title="&#39;MQL&#39; vs. SQL" class="dd-item 
        
        
        
        ">
      <a href="/mongodb-guide/en/rw_data_guide/mql_vs_sql/">
          &#39;MQL&#39; vs. SQL
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/mongodb-guide/en/rw_data_guide/bulk_writes/" title="Bulk writes API" class="dd-item 
        
        
        
        ">
      <a href="/mongodb-guide/en/rw_data_guide/bulk_writes/">
          Bulk writes API
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/mongodb-guide/en/rw_data_guide/bson_format/" title="The data: BSON documents" class="dd-item 
        
        
        
        ">
      <a href="/mongodb-guide/en/rw_data_guide/bson_format/">
          The data: BSON documents
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/mongodb-guide/en/rw_data_guide/crud_gof/" title="Queries, Inserts, Updates and Deletes" class="dd-item 
        
        
        
        ">
      <a href="/mongodb-guide/en/rw_data_guide/crud_gof/">
          The CRUD G.o.F.
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/mongodb-guide/en/rw_data_guide/crud_gof/find_cmd/" title="The find command" class="dd-item 
        
        
        
        ">
      <a href="/mongodb-guide/en/rw_data_guide/crud_gof/find_cmd/">
          find
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/mongodb-guide/en/rw_data_guide/crud_gof/insert_cmd/" title="The insert command" class="dd-item 
        
        
        
        ">
      <a href="/mongodb-guide/en/rw_data_guide/crud_gof/insert_cmd/">
          insert
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/mongodb-guide/en/rw_data_guide/crud_gof/update_cmd/" title="The update command" class="dd-item 
        
        
        
        ">
      <a href="/mongodb-guide/en/rw_data_guide/crud_gof/update_cmd/">
          update
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/mongodb-guide/en/rw_data_guide/crud_gof/delete_cmd/" title="The delete command" class="dd-item 
        
        
        
        ">
      <a href="/mongodb-guide/en/rw_data_guide/crud_gof/delete_cmd/">
          delete
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/mongodb-guide/en/stability_guide/" title="Making MongoDB stable" class="dd-item 
        parent
        
        
        ">
      <a href="/mongodb-guide/en/stability_guide/">
          <b>4. </b>Making MongoDB stable
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/mongodb-guide/en/stability_guide/performance/" title="Performance stability" class="dd-item 
        parent
        active
        
        ">
      <a href="/mongodb-guide/en/stability_guide/performance/">
          Performance stability
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li> 
                  <a class="padding" href="https://github.com/akira-kurogane/mongodb-guide"><i class='fa fa-fw fa-github'></i> Github repo</a>
              </li>
          
              <li> 
                  <a class="padding" href="https://akira-kurogane.github.io/en/mongodb-guide/credits"><i class='fa fa-fw fa-bullhorn'></i> Theme credits</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      
        <li>
          <a class="padding">
            <i class="fas fa-language fa-fw"></i>
          <div class="select-style">
            <select id="select-language" onchange="location = this.value;">
          
          
          
              
              
                  
                    
                    
                      <option id="en" value="https://akira-kurogane.github.io/mongodb-guide/en/stability_guide/performance/" selected>English</option>
                    
                  
              
                  
              
          
        </select>
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
          width="255px" height="255px" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255;" xml:space="preserve">
          <g>
            <g id="arrow-drop-down">
              <polygon points="0,63.75 127.5,191.25 255,63.75 		" />
            </g>
          </g>
        </svg>
        </div>
        </a>
        </li>
      
      
      
        <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> Clear History</a></li>
      
      </ul>
    </section>
    
    <section id="footer">
      <center>

    Github repo: 
    
    <a class="github-button" href="https://github.com/akira-kurogane/mongodb-guide" data-icon="octicon-star" data-show-count="false" aria-label="Star Akira's MongoDB Guide on GitHub">Star</a>

    
    <a class="github-button" href="https://github.com/akira-kurogane/mongodb-guide/fork" data-icon="octicon-repo-forked" data-show-count="false" aria-label="Fork Akira's MongoDB Guide on GitHub">Fork</a>

</center>

<script async defer src="https://buttons.github.io/buttons.js"></script>

    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='/mongodb-guide/en/'>Top page</a> > <a href='/mongodb-guide/en/stability_guide/'>Making MongoDB stable</a> > Performance stability
          
         
          
         
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#exceptions-to-the-above">Exceptions to the above</a>
<ul>
<li><a href="#checkpoints">Checkpoints</a></li>
<li><a href="#shard-balancing">Shard balancing</a></li>
<li><a href="#ttl-indexes">TTL Indexes</a></li>
<li><a href="#the-os-performance-is-unstable">The OS performance is unstable</a></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Performance stability
            </h1>
          

        




	

<p>This chapter's title implies that MongDB has a performance stability issue. It does not.</p>

<p>MongoDB performance stability is primarily about application load stability. And this is true of all database's I've worked with.</p>

<p>DBAs: you must not take responsibility <strong>EVER</strong> for application load instability. Unless it is your responsibility to be the development team's manager as well, in which case make sure you get that in writing and a pay rise to match.</p>

<h3 id="exceptions-to-the-above">Exceptions to the above</h3>

<h4 id="checkpoints">Checkpoints</h4>

<p>When there are a lot of writes (think many GB/s per minute as a rough guide) there is variation in the MongoDB performance during checkpoints. Checkpoints are when the changes that have been made in memory are flushed to disk. If you get slow command latency appearing once per minute for a second or several, and you see disk utilization rising to 100% at the same time, this would be what it is.</p>

<h4 id="shard-balancing">Shard balancing</h4>

<p>One internal thing that can add real load to a given pair of shards is the movement of data (and deletion clean-up after) between shards to balance the number of chunks for sharded collections between them. (&quot;chunks&quot; are ranges of docs up to a certain size, default 64MB.)</p>

<p>One chunk being moved is barely noticeable. But when you shard a collection for the first time, or add a new shard, they will happen continuously for a long time. This means there will be batch inserts on the recipient shard(s) and deletes on the donating shard(s). A signficant impact if there is already continually heavy load from the users on the database.</p>

<p>Don't overlook the cost of deletes, and be aware they get asynchronously scheduled to run after. ASAP if not too much load, but it could be delayed for a long time.</p>

<h4 id="ttl-indexes">TTL Indexes</h4>

<p>Two things to be aware of regarding time-to-live indexes</p>

<ul>
<li>Once per minute. The TTL index deletes are executed by a background thread that sleeps for 60 secs by default before iterating all indexes with the &quot;expireAfterSeconds&quot; field. If the deletes take, say, 0.3s in total each minute there will be 60.3s cycle of deletes appearing. This is a different cycle to checkpoints. Eventually they will overlap, then move apart, then move over again, etc.</li>
<li>If a large number of docs match the TTL clause there will be no mercy - the mongod node will process the deletes for all them at once. And deletes are basically as costly as updates (they have to be - the documents have to be read to get the values that are the keys that should be removed from the secondary indexes). It is a common mistake to create a new TTL index to keep a collection smaller and not think that the first TTL 'pass' might be deleting a huge fraction of the collection in one go.</li>
</ul>

<p>If you would like a much more constant cost and can accept a policy based on <em>size</em> rather than a timestamp-value limit, please use capped collections.</p>

<h4 id="the-os-performance-is-unstable">The OS performance is unstable</h4>

<p>This is not really a DB issue of course. But if your DB server is a shared physical server you may have other big applications competing for the same resources, affecting the mongod process's top processing rate.</p>

<p>Another form of OS instability is when the kernel or library performance is not even. This is rare given how well-written the Linux kernel is, but I can think of at least two known issues.</p>

<ul>
<li>Memory alloc libs manage large page lists - when there is large memory (say 256GB+) the number of pages can be large, and an occasional defrag of those pages can be heavily blocking to user processes until it completes.</li>
<li>Filesystems are not all equal. Ext4 (or Ext3) are not as good as XFS, because they can also block when managing large number of file pages.</li>
</ul>





<footer class=" footline" >
	
</footer>

        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="/mongodb-guide/en/stability_guide/" title="Making MongoDB stable"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/mongodb-guide/en/guide_intro/" title="What you can do with MongoDB" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/mongodb-guide/js/clipboard.min.js?1571450476"></script>
    <script src="/mongodb-guide/js/perfect-scrollbar.min.js?1571450476"></script>
    <script src="/mongodb-guide/js/perfect-scrollbar.jquery.min.js?1571450476"></script>
    <script src="/mongodb-guide/js/jquery.sticky.js?1571450476"></script>
    <script src="/mongodb-guide/js/featherlight.min.js?1571450476"></script>
    <script src="/mongodb-guide/js/html5shiv-printshiv.min.js?1571450476"></script>
    <script src="/mongodb-guide/js/highlight.pack.js?1571450476"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/mongodb-guide/js/modernizr.custom-3.6.0.js?1571450476"></script>
    <script src="/mongodb-guide/js/learn.js?1571450476"></script>
    <script src="/mongodb-guide/js/hugo-learn.js?1571450476"></script>

    <link href="/mongodb-guide/mermaid/mermaid.css?1571450476" type="text/css" rel="stylesheet" />
    <script src="/mongodb-guide/mermaid/mermaid.js?1571450476"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-105947713-1', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
